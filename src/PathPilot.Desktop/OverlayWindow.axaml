<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:models="clr-namespace:PathPilot.Core.Models;assembly=PathPilot.Core"
        x:Class="PathPilot.Desktop.OverlayWindow"
        Title="PathPilot Overlay"
        TransparencyLevelHint="Transparent"
        Background="Transparent"
        SystemDecorations="None"
        ShowInTaskbar="False"
        Topmost="True"
        SizeToContent="Height"
        Width="320"
        MinHeight="200"
        MaxHeight="800"
        CanResize="False">

    <Border Background="#CC1E1E1E"
            CornerRadius="8"
            Padding="15">
        <Grid RowDefinitions="Auto,Auto,*,Auto">
            <!-- Header - Draggable -->
            <Border Name="DragHandle"
                    Grid.Row="0"
                    Background="#33ffffff"
                    CornerRadius="4"
                    Padding="10,8"
                    Margin="0,0,0,10"
                    Cursor="Hand">
                <Grid ColumnDefinitions="*,Auto">
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock Name="BuildNameText"
                                   Text="No Build Loaded"
                                   FontSize="14"
                                   FontWeight="Bold"
                                   Foreground="White"/>
                        <TextBlock Name="CharacterInfoText"
                                   Text=""
                                   FontSize="11"
                                   Foreground="#aaa"/>
                    </StackPanel>
                    <TextBlock Grid.Column="1"
                               Text="⋮⋮"
                               FontSize="16"
                               Foreground="#666"
                               VerticalAlignment="Center"
                               ToolTip.Tip="Drag to move"/>
                </Grid>
            </Border>

            <!-- Tab Buttons -->
            <Grid Grid.Row="1" ColumnDefinitions="*,*" Margin="0,0,0,10">
                <Button Name="GemsTabButton"
                        Grid.Column="0"
                        Content="Gems"
                        Click="GemsTabButton_Click"
                        Background="#4a9eff"
                        Foreground="White"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Center"
                        Padding="8,6"
                        Margin="0,0,5,0"
                        CornerRadius="4"/>
                <Button Name="QuestsTabButton"
                        Grid.Column="1"
                        Content="Quests"
                        Click="QuestsTabButton_Click"
                        Background="#404040"
                        Foreground="White"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Center"
                        Padding="8,6"
                        Margin="5,0,0,0"
                        CornerRadius="4"/>
            </Grid>

            <!-- Content Area -->
            <ScrollViewer Grid.Row="2"
                          VerticalScrollBarVisibility="Auto"
                          MaxHeight="500">
                <Grid>
                    <!-- Gems Panel -->
                    <StackPanel Name="GemsPanel" Spacing="10" IsVisible="True">
                        <TextBlock Text="SKILL GEMS"
                                   FontSize="11"
                                   FontWeight="SemiBold"
                                   Foreground="#666"
                                   Margin="0,0,0,5"/>

                        <ItemsControl Name="GemsListBox">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="models:GemLinkGroup">
                                    <Border Background="#33333333"
                                            CornerRadius="5"
                                            Padding="10"
                                            Margin="0,0,0,8">
                                        <StackPanel Spacing="4">
                                            <TextBlock FontSize="12"
                                                       FontWeight="SemiBold"
                                                       Foreground="#4aff9d"
                                                       Margin="0,0,0,4">
                                                <Run Text="{Binding Key}"/>
                                            </TextBlock>
                                            <ItemsControl ItemsSource="{Binding Value}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="models:Gem">
                                                        <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,2">
                                                            <!-- Gem Icon -->
                                                            <Image Grid.Column="0"
                                                                   Width="16" Height="16"
                                                                   Margin="0,0,8,0"
                                                                   VerticalAlignment="Center"
                                                                   Source="{Binding IconPath, Converter={StaticResource GemIconBitmapConverter}}"
                                                                   IsVisible="{Binding HasIcon}"/>
                                                            <!-- Color Dot Fallback -->
                                                            <Border Grid.Column="0"
                                                                    Width="8" Height="8"
                                                                    CornerRadius="4"
                                                                    Margin="0,0,8,0"
                                                                    VerticalAlignment="Center"
                                                                    IsVisible="{Binding !HasIcon}">
                                                                <Border.Background>
                                                                    <SolidColorBrush Color="{Binding Color, Converter={StaticResource GemColorConverter}}"/>
                                                                </Border.Background>
                                                            </Border>
                                                            <TextBlock Grid.Column="1"
                                                                       Text="{Binding Name}"
                                                                       FontSize="11"
                                                                       Foreground="{Binding IsSupport, Converter={StaticResource OverlaySupportColorConverter}}"
                                                                       VerticalAlignment="Center"
                                                                       TextTrimming="CharacterEllipsis"/>
                                                            <TextBlock Grid.Column="2"
                                                                       FontSize="10"
                                                                       Foreground="#888"
                                                                       VerticalAlignment="Center"
                                                                       Margin="5,0,0,0">
                                                                <Run Text="{Binding Level}"/>/<Run Text="{Binding Quality}"/>
                                                            </TextBlock>
                                                        </Grid>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>

                    <!-- Quests Panel -->
                    <StackPanel Name="QuestsPanel" Spacing="6" IsVisible="False">

                        <!-- Quest Category Tabs -->
                        <Grid ColumnDefinitions="*,*,*" Margin="0,0,0,4">
                            <Button Name="SkillPointsTabButton"
                                    Grid.Column="0"
                                    Content="Skills"
                                    Click="SkillPointsTabButton_Click"
                                    Background="#4a9eff"
                                    Foreground="White"
                                    FontSize="11"
                                    HorizontalAlignment="Stretch"
                                    HorizontalContentAlignment="Center"
                                    Padding="4,4"
                                    Margin="0,0,3,0"
                                    CornerRadius="3"/>
                            <Button Name="TrialsTabButton"
                                    Grid.Column="1"
                                    Content="Trials"
                                    Click="TrialsTabButton_Click"
                                    Background="#404040"
                                    Foreground="White"
                                    FontSize="11"
                                    HorizontalAlignment="Stretch"
                                    HorizontalContentAlignment="Center"
                                    Padding="4,4"
                                    Margin="0,0,3,0"
                                    CornerRadius="3"/>
                            <Button Name="LabsTabButton"
                                    Grid.Column="2"
                                    Content="Labs"
                                    Click="LabsTabButton_Click"
                                    Background="#404040"
                                    Foreground="White"
                                    FontSize="11"
                                    HorizontalAlignment="Stretch"
                                    HorizontalContentAlignment="Center"
                                    Padding="4,4"
                                    Margin="0,0,0,0"
                                    CornerRadius="3"/>
                        </Grid>

                        <!-- Filter Row -->
                        <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,4">
                            <CheckBox Name="HideCompletedCheckBox"
                                      Grid.Column="0"
                                      Content="Erledigte ausblenden"
                                      FontSize="10"
                                      Foreground="#aaa"
                                      Click="HideCompletedCheckBox_Click"
                                      VerticalAlignment="Center"/>
                            <TextBlock Name="QuestProgressText"
                                       Grid.Column="2"
                                       FontSize="10"
                                       Foreground="#888"
                                       VerticalAlignment="Center"/>
                        </Grid>

                        <!-- Quest List -->
                        <ItemsControl Name="QuestsListBox">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="models:Quest">
                                    <Border Background="#33333333"
                                            CornerRadius="4"
                                            Padding="8"
                                            Margin="0,0,0,4">
                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                            <CheckBox Grid.Column="0"
                                                      IsChecked="{Binding IsCompleted}"
                                                      Margin="0,0,8,0"
                                                      VerticalAlignment="Center"/>
                                            <StackPanel Grid.Column="1" Spacing="2">
                                                <TextBlock Text="{Binding Name}"
                                                           FontSize="12"
                                                           Foreground="White"
                                                           TextDecorations="{Binding IsCompleted, Converter={StaticResource CompletedTextDecorationConverter}}"/>
                                                <StackPanel Orientation="Horizontal" Spacing="10">
                                                    <TextBlock FontSize="10" Foreground="#888">
                                                        <Run Text="Act "/>
                                                        <Run Text="{Binding Act}"/>
                                                    </TextBlock>
                                                    <TextBlock Text="{Binding Location}"
                                                               FontSize="10"
                                                               Foreground="#4aff9d"/>
                                                </StackPanel>
                                                <!-- Trap Type for Trials -->
                                                <TextBlock Name="TrapTypeText"
                                                           Text="{Binding TrapType}"
                                                           FontSize="10"
                                                           Foreground="#ff9d4a"
                                                           IsVisible="{Binding TrapType, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                            </StackPanel>
                                            <!-- Reward Badge -->
                                            <Border Grid.Column="2"
                                                    Background="#33ffffff"
                                                    CornerRadius="3"
                                                    Padding="5,2"
                                                    VerticalAlignment="Center"
                                                    IsVisible="{Binding RewardDescription, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                                <TextBlock Text="{Binding RewardDescription}"
                                                           FontSize="9"
                                                           Foreground="#ffcc00"
                                                           VerticalAlignment="Center"/>
                                            </Border>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Grid>
            </ScrollViewer>

            <!-- Footer - Hotkey Info -->
            <Border Grid.Row="3"
                    Background="#22ffffff"
                    CornerRadius="4"
                    Padding="8,5"
                    Margin="0,10,0,0">
                <StackPanel>
                    <TextBlock Name="HotkeyInfoText"
                               Text="F11: Toggle | Ctrl+F11: Interact"
                               FontSize="10"
                               Foreground="#888"
                               HorizontalAlignment="Center"/>
                    <TextBlock Name="ModeText"
                               Text="Click-Through"
                               FontSize="10"
                               Foreground="#4aff9d"
                               HorizontalAlignment="Center"
                               Margin="0,2,0,0"/>
                </StackPanel>
            </Border>
        </Grid>
    </Border>
</Window>

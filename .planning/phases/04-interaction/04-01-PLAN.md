---
phase: 04-interaction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs
autonomous: false

must_haves:
  truths:
    - "Hovering over a node displays tooltip with node name"
    - "Tooltip shows which nodes are connected to the hovered node"
    - "Tooltip disappears when moving off nodes"
    - "Tooltip does not flicker during pan or zoom"
  artifacts:
    - path: "src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs"
      provides: "Hover detection and tooltip display"
      contains: "_hoveredNodeId"
      contains: "FindNodeAtPosition"
      contains: "ToolTip.SetTip"
      contains: "ToolTip.SetIsOpen"
  key_links:
    - from: "OnPointerMoved"
      to: "FindNodeAtPosition"
      via: "world coordinate hit testing"
      pattern: "FindNodeAtPosition.*ScreenToWorld"
    - from: "FindNodeAtPosition"
      to: "UpdateTooltip"
      via: "hover state change detection"
      pattern: "_hoveredNodeId.*UpdateTooltip"
    - from: "UpdateTooltip"
      to: "ToolTip.SetTip"
      via: "Avalonia tooltip API"
      pattern: "ToolTip\\.SetTip.*ToolTip\\.SetIsOpen"
---

<objective>
Add hover-based node tooltips to the skill tree viewer

Purpose: Allow users to explore node information by hovering over nodes in the skill tree, showing the node name and its connections. This completes the interactive experience for the native skill tree viewer.

Output: Modified SkillTreeCanvas.cs with hover detection, tooltip content building, and tooltip display logic
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase research with architecture patterns and code examples
@.planning/phases/04-interaction/04-RESEARCH.md

# Prior phase summary (provides coordinate transformation, pointer event patterns)
@.planning/phases/03-navigation/03-01-SUMMARY.md

# Implementation files
@src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs
@src/PathPilot.Core/Models/SkillTree.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement hover detection and state tracking</name>
  <files>src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs</files>
  <action>
Add hover detection infrastructure to SkillTreeCanvas:

1. Add hover state field at class level (near other navigation state fields):
```csharp
private int? _hoveredNodeId = null;
```

2. Add `FindNodeAtPosition(SKPoint worldPos)` method that:
   - Returns `int?` (node ID or null)
   - Iterates through TreeData.Nodes.Values
   - Skips nodes without CalculatedX/CalculatedY
   - Calculates Euclidean distance from worldPos to node center
   - Uses node-type-based radius (Keystone=18f, Notable=12f, JewelSocket=10f, Normal=6f)
   - Returns first node where distance <= radius, or null if none

3. Modify existing `OnPointerMoved` to add hover detection BEFORE the panning logic:
   - If NOT panning and TreeData is not null:
     - Convert screen position to world using existing ScreenToWorld()
     - Call FindNodeAtPosition()
     - If result differs from _hoveredNodeId, update _hoveredNodeId and call UpdateTooltip()
   - If panning and _hoveredNodeId has value:
     - Clear _hoveredNodeId to null
     - Call ToolTip.SetIsOpen(this, false)

4. Add `OnPointerExited` override:
   - Call base.OnPointerExited(e)
   - If _hoveredNodeId has value, clear it and call ToolTip.SetIsOpen(this, false)

5. Modify existing `OnPointerWheelChanged` to clear hover during zoom:
   - After existing zoom logic, add: if _hoveredNodeId has value, clear it and call ToolTip.SetIsOpen(this, false)

Note: Use existing ScreenToWorld() method for coordinate transformation. The radius values match those used in DrawNodes().
  </action>
  <verify>
Build succeeds: `dotnet build src/PathPilot.Desktop/`
Grep confirms new methods exist: `grep -n "FindNodeAtPosition\|_hoveredNodeId" src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs`
  </verify>
  <done>
- _hoveredNodeId field exists
- FindNodeAtPosition method returns node ID when hovering over node
- OnPointerMoved calls FindNodeAtPosition when not panning
- OnPointerExited clears hover state
- OnPointerWheelChanged clears hover during zoom
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement tooltip display with node info and connections</name>
  <files>src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs</files>
  <action>
Add tooltip content building and display to SkillTreeCanvas:

1. Add required using statements at top of file (if not present):
```csharp
using Avalonia.Controls;
using Avalonia.Layout;
```

2. Add `BuildTooltipContent(PassiveNode node)` method that returns `object`:
   - Create StackPanel with Spacing=4
   - Add TextBlock for node name (FontWeight=Bold, FontSize=14)
   - If node.Stats has items, add each stat as TextBlock (FontSize=12)
   - Add separator TextBlock "Connected to:" (FontWeight=SemiBold, Margin top=8) if ConnectedNodes > 0
   - For each connected node ID (limit to first 15):
     - Look up node in TreeData.Nodes
     - Add TextBlock with bullet point and node name (FontSize=11)
   - If ConnectedNodes.Count > 15, add "... and N more" TextBlock
   - Return the StackPanel

3. Add `UpdateTooltip()` method:
   - If _hoveredNodeId has value AND TreeData is not null:
     - Try get node from TreeData.Nodes using _hoveredNodeId.Value
     - If found: call BuildTooltipContent(node), then ToolTip.SetTip(this, content), then ToolTip.SetIsOpen(this, true)
     - Return after setting tooltip
   - Otherwise: call ToolTip.SetIsOpen(this, false)

4. Wire up UpdateTooltip() to be called from OnPointerMoved (should already be in Task 1's hover detection logic)

Styling notes:
- Use Avalonia.Media.FontWeight.Bold and FontWeight.SemiBold
- Margin for separator: new Thickness(0, 8, 0, 0)
- No explicit colors (let theme handle it for light/dark mode compatibility)
  </action>
  <verify>
Build succeeds: `dotnet build src/PathPilot.Desktop/`
Grep confirms tooltip methods: `grep -n "BuildTooltipContent\|UpdateTooltip\|ToolTip.SetTip" src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs`
  </verify>
  <done>
- BuildTooltipContent returns StackPanel with node name, stats, and connected nodes
- UpdateTooltip shows/hides tooltip based on hover state
- Connected nodes are limited to 15 with overflow indicator
- Tooltip content uses theme-compatible styling
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete hover tooltip system for skill tree nodes</what-built>
  <how-to-verify>
1. Run the application: `dotnet run --project src/PathPilot.Desktop/`
2. Load a build with allocated nodes (import a PoB code or load a saved build)
3. Click "Skill Tree" to open TreeViewerWindow
4. Wait for tree to render and center on allocated nodes
5. Hover over various nodes and verify:
   - Tooltip appears showing node name
   - Node stats are shown (if any)
   - Connected nodes are listed
   - Tooltip disappears when moving off nodes
6. Test edge cases:
   - Hover while panning (tooltip should NOT appear during drag)
   - Zoom with mouse wheel while hovering (tooltip should disappear)
   - Move mouse outside the canvas (tooltip should disappear)
   - Hover over different node types (keystone, notable, normal)
  </how-to-verify>
  <resume-signal>Type "approved" if tooltip works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] Build succeeds without errors
- [ ] Hover over node shows tooltip with name (INT-01)
- [ ] Tooltip shows connected nodes (INT-02)
- [ ] Tooltip hides when moving off nodes
- [ ] No tooltip flicker during pan or zoom
- [ ] Different node types (keystone, notable, normal) all show tooltips
</verification>

<success_criteria>
Phase 4 complete when:
1. Hovering over any node displays tooltip with node name
2. Tooltip displays connected nodes list
3. Tooltip behavior is smooth (no flicker during pan/zoom)
4. User verifies functionality works as expected
</success_criteria>

<output>
After completion, create `.planning/phases/04-interaction/04-01-SUMMARY.md` following the standard summary template.
</output>

---
phase: 05-sprite-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Keystone sprites render with correctly aligned backgrounds/frames"
    - "Group background images render properly aligned behind all node clusters"
  artifacts:
    - path: "src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs"
      provides: "Fixed alignment logic for keystone frames and group backgrounds"
      contains: "DrawBitmap"
  key_links:
    - from: "src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs"
      to: "src/PathPilot.Core/Models/SpriteSheet.cs"
      via: "SpriteCoordinate W/H used for centering calculations"
      pattern: "halfW.*halfH"
---

<objective>
Fix alignment issues with keystone sprite backgrounds and group background images. User reported "at some keystones the background is not aligned right" and "not all of them are aligned properly" for group backgrounds.

Purpose: Cosmetic polish to make the tree viewer match GGG's official rendering quality.
Output: Correctly positioned keystone frames and group backgrounds for all node types.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-sprite-foundation/05-01-SUMMARY.md
@.planning/phases/05-sprite-foundation/05-UAT.md
@src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs
@src/PathPilot.Core/Models/SpriteSheet.cs
@src/PathPilot.Core/Models/SkillTreeData.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix keystone and group background sprite alignment</name>
  <files>
    src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs
    src/PathPilot.Core/Models/SpriteSheet.cs
    src/PathPilot.Core/Services/SkillTreeDataService.cs
  </files>
  <action>
    **Root cause analysis:**

    The alignment issues have two likely causes:

    1. **Keystone frame/icon mismatch**: In `TryDrawNodeSprite` and `TryDrawNodeFrame`, both use `coord.W/2 * _spriteScale` and `coord.H/2 * _spriteScale` to center the sprite on the node position. However, the ICON sprite and the FRAME sprite have DIFFERENT dimensions (W/H) in GGG's sprite sheets. The frame is typically larger than the icon. Both are correctly centered on the node's (x,y), but if the icon and frame have different aspect ratios or if one has non-square dimensions, they won't align visually.

       **Investigation step**: Add debug logging to `TryDrawNodeSprite` and `TryDrawNodeFrame` for keystone nodes to print the icon and frame coord dimensions. Look for cases where the icon is not centered within the frame.

       **Fix**: The icon should render at its natural size centered on (x,y). The frame should ALSO render at its natural size centered on (x,y). If GGG designed them to align when both are centered, this should work. If not, the frame may need an offset. Check if GGG's data includes any offset values we're missing.

    2. **Group background positioning**: In `DrawGroupBackgrounds`, backgrounds are centered on `group.X, group.Y`. However, GGG's tree data may include additional offset properties on the background that we're not parsing. Check the JSON structure:
       - `background.image` -- we parse this
       - `background.isHalfImage` -- we parse this
       - `background.offsetX` / `background.offsetY` -- we may NOT be parsing these

       **Investigation step**: Read the raw GGG JSON file from cache (`~/.config/PathPilot/tree-cache/poe1-3.25.json`) and check a sample group's `background` object for any additional properties beyond `image` and `isHalfImage`.

    **A. Check GGG JSON for background offset properties:**

    Read the cached tree JSON and check the `groups` -> any group with `background` -> look for properties like `offsetX`, `offsetY`, or similar. The PoE passive tree JSON format from `poe-tool-dev/passive-skill-tree-json` may include:
    ```json
    "background": {
      "image": "PSGroupBackground3",
      "isHalfImage": true,
      "offsetX": 0,    // <-- might exist
      "offsetY": 0     // <-- might exist
    }
    ```

    If offset properties exist, parse them in `SkillTreeDataService.ParseGroup()` and add `OffsetX`/`OffsetY` float properties to the `GroupBackground` model in `SpriteSheet.cs`. Then apply these offsets in `DrawGroupBackgrounds`:
    ```csharp
    var bgX = group.X + (group.Background.OffsetX ?? 0);
    var bgY = group.Y + (group.Background.OffsetY ?? 0);
    ```

    **B. Fix keystone sprite centering:**

    The current approach centers both icon and frame on (x,y) with their respective half-widths. This is correct IF the sprites are designed to be centered. However, keystones are large sprites and even small pixel-level misalignment is visible.

    Potential fixes:
    1. **Use the same dest rect for both icon and frame**: Calculate a unified bounding box. The frame defines the visual boundary, and the icon should fit within it. Use the FRAME's dimensions as the outer bound, and scale the icon to fit within.
    2. **Check if frame coords include the icon area**: In GGG's sprite sheets, the frame might already include the icon backdrop. If so, we might be double-drawing.
    3. **Add debug rectangles**: Temporarily draw red outlines around icon destRect and blue outlines around frame destRect for keystone nodes. This will visually reveal the misalignment.

    **Concrete implementation approach:**

    a) Add temporary debug logging in `TryDrawNodeSprite` for keystones:
    ```csharp
    if (node.IsKeystone)
        Console.WriteLine($"Keystone {node.Name}: icon={iconKey} w={coord.W} h={coord.H}, destRect=({destRect.Left:F0},{destRect.Top:F0},{destRect.Right:F0},{destRect.Bottom:F0})");
    ```
    And in `TryDrawNodeFrame` for keystones:
    ```csharp
    if (node.IsKeystone)
        Console.WriteLine($"Keystone frame {node.Name}: frame={frameKey} w={coord.W} h={coord.H}, destRect=({destRect.Left:F0},{destRect.Top:F0},{destRect.Right:F0},{destRect.Bottom:F0})");
    ```

    b) Run the app and examine the output. Compare icon vs frame dimensions for keystones.

    c) Based on findings, fix the alignment. Most likely fix: ensure both icon and frame use the same center point and the frame is slightly larger (as designed by GGG). If the frame has non-uniform padding (e.g., thicker at top), we may need to offset.

    d) Remove debug logging after fix is confirmed.

    **C. Fix group background half-image mirroring:**

    The current `isHalfImage` handling mirrors the background horizontally around the group center:
    ```csharp
    canvas.Save();
    canvas.Translate(group.X, group.Y);
    canvas.Scale(-1, 1);
    canvas.Translate(-group.X, -group.Y);
    canvas.DrawBitmap(bgBitmap, srcRect, destRect, bitmapPaint);
    canvas.Restore();
    ```

    This is mathematically correct for horizontal mirroring around group.X. However, if the background sprite itself is not symmetric (some GGG group backgrounds are elliptical or have irregular shapes), the mirrored half may not align with the original half.

    Verify: Look at the rendered backgrounds and check if the gap/overlap is at the centerline (mirror joint) or if the entire background is shifted. If shifted, it's an offset issue. If at the centerline, it's a mirror issue.

    **D. Ensure all modifications are consistent with the tile cache from Plan 03:**

    If Plan 03 introduces a tile cache, alignment fixes here will be rendered into that cache. No special coordination needed -- just make sure `InvalidateTileCache()` is called (or the cache is marked dirty) when these changes affect rendering.

  </action>
  <verify>
    `dotnet build src/PathPilot.Desktop/PathPilot.Desktop.csproj` compiles without errors.
    Run the app, open tree viewer, zoom in to keystone nodes:
    1. Keystone icon sprites are centered within their frames (no visible offset)
    2. Group backgrounds are properly centered behind their node clusters
    3. Half-image backgrounds render as continuous shapes (no gap at centerline)
    4. Compare to GGG's official tree at pathofexile.com/passive-skill-tree -- alignment should be similar
  </verify>
  <done>
    Keystone sprites render with properly aligned frames. Group backgrounds render at correct positions behind node clusters. No visible misalignment compared to GGG's official rendering.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Alignment visual verification</name>
  <files></files>
  <action>
    User verifies that keystone sprite alignment and group background positioning match GGG's official tree rendering.
  </action>
  <verify>
    1. Run `dotnet run --project src/PathPilot.Desktop/PathPilot.Desktop.csproj`
    2. Import a build and open the Skill Tree viewer
    3. Zoom in to KEYSTONE nodes (the large ones). Check:
       a. The icon sprite is centered within the decorative frame
       b. No visible offset or misalignment between icon and frame
    4. Zoom out to see GROUP BACKGROUNDS (the circular/orbital shapes behind node clusters). Check:
       a. Backgrounds are centered on their node groups
       b. No backgrounds that appear shifted or misaligned
       c. Half-image backgrounds render as continuous shapes
    5. Compare visually with pathofexile.com/passive-skill-tree for reference
  </verify>
  <done>
    User confirms: keystone sprites aligned with frames, group backgrounds properly positioned, no visible misalignment.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds without errors
2. Keystone sprites properly aligned with their frames
3. Group backgrounds properly centered on node clusters
4. Half-image backgrounds render continuously
5. No regression in other sprite rendering (normals, notables, jewels)
6. All existing interactions still work (pan, zoom, hover, tooltips)
</verification>

<success_criteria>
- Gap 1 (cosmetic): Keystone sprite backgrounds aligned correctly -- CLOSED
- Gap 3 (cosmetic): Group background images aligned properly -- CLOSED
- No regression in existing sprite rendering quality
</success_criteria>

<output>
After completion, create `.planning/phases/05-sprite-foundation/05-04-SUMMARY.md`
</output>

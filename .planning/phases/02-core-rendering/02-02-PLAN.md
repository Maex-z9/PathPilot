---
phase: 02-core-rendering
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/PathPilot.Desktop/TreeViewerWindow.axaml
  - src/PathPilot.Desktop/TreeViewerWindow.axaml.cs
autonomous: false

must_haves:
  truths:
    - "TreeViewerWindow displays native canvas instead of WebView"
    - "All tree nodes render at correct positions"
    - "Connections between nodes are visible"
    - "Allocated nodes appear in gold color, unallocated in dark gray"
  artifacts:
    - path: "src/PathPilot.Desktop/TreeViewerWindow.axaml"
      provides: "XAML layout with SkillTreeCanvas"
      contains: "SkillTreeCanvas"
    - path: "src/PathPilot.Desktop/TreeViewerWindow.axaml.cs"
      provides: "Data loading and position calculation"
      contains: "SkillTreeDataService"
  key_links:
    - from: "src/PathPilot.Desktop/TreeViewerWindow.axaml.cs"
      to: "SkillTreeDataService"
      via: "GetTreeDataAsync call"
      pattern: "GetTreeDataAsync"
    - from: "src/PathPilot.Desktop/TreeViewerWindow.axaml.cs"
      to: "SkillTreePositionHelper"
      via: "CalculateAllPositions call"
      pattern: "CalculateAllPositions"
    - from: "src/PathPilot.Desktop/TreeViewerWindow.axaml"
      to: "SkillTreeCanvas"
      via: "XAML element binding"
      pattern: "local:SkillTreeCanvas"
---

<objective>
Wire SkillTreeCanvas to TreeViewerWindow and render full tree with allocated node highlighting

Purpose: Complete the native skill tree rendering by integrating the canvas control into the existing window
Output: TreeViewerWindow displays native rendered skill tree with ~1300 nodes and allocated highlighting
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-rendering/02-RESEARCH.md
@.planning/phases/02-core-rendering/02-01-SUMMARY.md

# Existing window to modify
@src/PathPilot.Desktop/TreeViewerWindow.axaml
@src/PathPilot.Desktop/TreeViewerWindow.axaml.cs

# Control created in Plan 01
@src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs

# Data services from Phase 1
@src/PathPilot.Core/Models/SkillTree.cs
@src/PathPilot.Core/Services/SkillTreeDataService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TreeViewerWindow XAML to use SkillTreeCanvas</name>
  <files>src/PathPilot.Desktop/TreeViewerWindow.axaml</files>
  <action>
Replace the WebView-based XAML with native SkillTreeCanvas.

1. **Remove WebView namespace and control:**
   - Remove `xmlns:wv="clr-namespace:WebViewControl;assembly=WebViewControl.Avalonia"`
   - Remove the `<wv:WebView>` element

2. **Add local namespace for Controls:**
   - Add `xmlns:local="clr-namespace:PathPilot.Desktop.Controls"`

3. **Replace WebView with SkillTreeCanvas:**
   - In Grid.Row="1", replace the Border+WebView with:
   ```xml
   <Border Grid.Row="1" Background="#0a0a0a" ClipToBounds="True">
       <ScrollViewer HorizontalScrollBarVisibility="Auto"
                     VerticalScrollBarVisibility="Auto">
           <local:SkillTreeCanvas Name="TreeCanvas"
                                  Width="10000"
                                  Height="10000" />
       </ScrollViewer>
   </Border>
   ```

4. **Update header buttons:**
   - Keep RefreshButton but change text to "Reload Tree"
   - Remove OpenExternalButton (no longer relevant for native rendering)
   - Or keep it to open pobb.in URL in browser (user convenience)

The canvas size 10000x10000 accommodates the full skill tree (GGG tree spans roughly -10000 to +10000 in both axes).
  </action>
  <verify>
File should have `local:SkillTreeCanvas` element and no `wv:WebView` element.
`grep "SkillTreeCanvas" src/PathPilot.Desktop/TreeViewerWindow.axaml` returns match.
`grep "WebView" src/PathPilot.Desktop/TreeViewerWindow.axaml` returns no match.
  </verify>
  <done>
TreeViewerWindow.axaml uses SkillTreeCanvas instead of WebView, with ScrollViewer for navigation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TreeViewerWindow code-behind to load and display tree data</name>
  <files>src/PathPilot.Desktop/TreeViewerWindow.axaml.cs</files>
  <action>
Update the code-behind to load tree data and pass it to the canvas.

1. **Add required usings:**
   ```csharp
   using PathPilot.Core.Models;
   using PathPilot.Core.Services;
   using PathPilot.Desktop.Controls;
   ```

2. **Add fields:**
   ```csharp
   private readonly SkillTreeDataService _treeDataService;
   private HashSet<int> _allocatedNodeIds = new();
   ```

3. **Modify constructor:**
   - Keep the parameterless constructor
   - In the constructor with (string treeUrl, string title), also accept `List<int>? allocatedNodes = null`
   - Store allocated nodes: `_allocatedNodeIds = allocatedNodes != null ? new HashSet<int>(allocatedNodes) : new();`
   - Initialize service: `_treeDataService = new SkillTreeDataService();`

4. **Update OnWindowOpened to load tree:**
   ```csharp
   private async void OnWindowOpened(object? sender, EventArgs e)
   {
       await LoadTreeAsync();
   }

   private async Task LoadTreeAsync()
   {
       try
       {
           var treeData = await _treeDataService.GetTreeDataAsync();
           if (treeData == null)
           {
               Console.WriteLine("Failed to load tree data");
               return;
           }

           // Calculate positions for all nodes
           SkillTreePositionHelper.CalculateAllPositions(treeData);

           // Apply offset to center tree (GGG coords can be negative)
           // Offset by 5000 to center in 10000x10000 canvas
           foreach (var node in treeData.Nodes.Values)
           {
               if (node.CalculatedX.HasValue)
                   node.CalculatedX += 5000;
               if (node.CalculatedY.HasValue)
                   node.CalculatedY += 5000;
           }

           // Set data on canvas
           TreeCanvas.TreeData = treeData;
           TreeCanvas.AllocatedNodeIds = _allocatedNodeIds;

           Console.WriteLine($"Tree loaded: {treeData.TotalNodes} nodes, {_allocatedNodeIds.Count} allocated");
       }
       catch (Exception ex)
       {
           Console.WriteLine($"Error loading tree: {ex.Message}");
       }
   }
   ```

5. **Update RefreshButton_Click:**
   ```csharp
   private async void RefreshButton_Click(object? sender, RoutedEventArgs e)
   {
       await LoadTreeAsync();
   }
   ```

6. **Remove NavigateToTree() method** (no longer needed)

7. **Keep OpenExternalButton_Click** if you kept the button (opens pobb.in or pathofexile.com URL)
  </action>
  <verify>
`dotnet build src/PathPilot.Desktop/PathPilot.Desktop.csproj` compiles successfully.
`grep "SkillTreeDataService" src/PathPilot.Desktop/TreeViewerWindow.axaml.cs` returns match.
`grep "CalculateAllPositions" src/PathPilot.Desktop/TreeViewerWindow.axaml.cs` returns match.
  </verify>
  <done>
TreeViewerWindow loads tree data via SkillTreeDataService, calculates positions, and passes data to SkillTreeCanvas.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Native skill tree rendering in TreeViewerWindow using SkiaSharp canvas instead of WebView</what-built>
  <how-to-verify>
1. Run the app: `dotnet run --project src/PathPilot.Desktop/PathPilot.Desktop.csproj`
2. Import a PoB build (use existing test build or import from pobb.in)
3. Click "Show Tree" button to open TreeViewerWindow
4. Verify:
   - Tree renders with circles and lines (not a web page)
   - ~1300 nodes visible when scrolling around
   - Connections (gray lines) connect the nodes
   - If build has allocated nodes, some circles should be gold colored
   - Scroll/drag to navigate the tree
5. Expected: Dark background with gray circles (unallocated) and gold circles (allocated) connected by gray lines
  </how-to-verify>
  <resume-signal>Type "approved" if tree renders correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `dotnet build src/PathPilot.Desktop/PathPilot.Desktop.csproj` compiles successfully
2. TreeViewerWindow.axaml contains SkillTreeCanvas element
3. TreeViewerWindow.axaml does NOT contain WebView element
4. TreeViewerWindow.axaml.cs loads tree data and calculates positions
5. Visual verification: Tree renders with nodes and connections in native canvas
</verification>

<success_criteria>
- TreeViewerWindow displays native Avalonia canvas (not WebView)
- All ~1300 nodes render at correct positions
- Connections between nodes are visible as gray lines
- Allocated nodes appear in gold color
- Unallocated nodes appear in dark gray
- User can scroll to navigate the tree
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-rendering/02-02-SUMMARY.md`
</output>

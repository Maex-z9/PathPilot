---
phase: 02-core-rendering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs
autonomous: true

must_haves:
  truths:
    - "SkillTreeCanvas control exists and compiles"
    - "Control accepts TreeData and AllocatedNodes as properties"
    - "ICustomDrawOperation renders to SKCanvas"
  artifacts:
    - path: "src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs"
      provides: "Custom Avalonia control with SkiaSharp rendering"
      min_lines: 150
      contains: "ICustomDrawOperation"
  key_links:
    - from: "src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs"
      to: "ISkiaSharpApiLeaseFeature"
      via: "TryGetFeature in Render method"
      pattern: "TryGetFeature<ISkiaSharpApiLeaseFeature>"
---

<objective>
Create SkillTreeCanvas custom control with ICustomDrawOperation for direct SkiaSharp rendering

Purpose: Establish the rendering foundation for native skill tree display without WebView
Output: SkillTreeCanvas.cs control that can render nodes and connections via SkiaSharp
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-rendering/02-RESEARCH.md

# Phase 1 artifacts (data foundation)
@src/PathPilot.Core/Models/SkillTreeData.cs
@src/PathPilot.Core/Models/SkillTree.cs
@src/PathPilot.Core/Services/SkillTreeDataService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SkillTreeCanvas control with ICustomDrawOperation</name>
  <files>src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs</files>
  <action>
Create new directory `Controls/` in PathPilot.Desktop if it doesn't exist.

Create SkillTreeCanvas.cs as an Avalonia Control that:

1. **Styled properties:**
   - `TreeData` (SkillTreeData?) - the parsed tree data from SkillTreeDataService
   - `AllocatedNodeIds` (HashSet<int>) - IDs of allocated nodes for highlighting
   - Use `AffectsRender<SkillTreeCanvas>()` in static constructor to trigger redraws

2. **Override Render(DrawingContext context):**
   - Return early if TreeData is null
   - Create SkillTreeDrawOperation with bounds, tree data, and allocated IDs
   - Call `context.Custom(operation)`

3. **Inner class SkillTreeDrawOperation : ICustomDrawOperation:**
   - Constructor takes Rect bounds, SkillTreeData, HashSet<int> allocatedIds
   - Implement Bounds property returning constructor bounds
   - Implement Dispose() - empty for now
   - Implement HitTest(Point p) returning false
   - Implement Equals(ICustomDrawOperation?) returning false
   - Implement Render(ImmediateDrawingContext context):
     - Get ISkiaSharpApiLeaseFeature via TryGetFeature
     - Return early if null
     - Use `using var lease = leaseFeature.Lease()`
     - Get `var canvas = lease.SkCanvas`
     - Call private RenderTree(canvas) method

4. **Private rendering methods in SkillTreeDrawOperation:**
   - `DrawConnections(SKCanvas canvas)`:
     - Create SKPath for batching all lines
     - Use HashSet to track drawn connections (avoid duplicates since connections are bidirectional)
     - For each node with CalculatedX/Y, draw lines to connected nodes
     - Use gray color (80, 80, 80), StrokeWidth=2, IsAntialias=true
     - Single DrawPath call at end

   - `DrawNodes(SKCanvas canvas)`:
     - Create two SKPaint objects (allocated=gold, unallocated=dark gray)
     - For each node with CalculatedX/Y:
       - Determine radius: Keystone=18f, Notable=12f, JewelSocket=10f, Normal=6f
       - Use gold (200, 150, 50) if allocated, dark gray (60, 60, 60) if not
       - DrawCircle at node position

Required using statements:
```csharp
using Avalonia;
using Avalonia.Controls;
using Avalonia.Media;
using Avalonia.Rendering.SceneGraph;
using Avalonia.Skia;
using PathPilot.Core.Models;
using SkiaSharp;
```

Follow the pattern from 02-RESEARCH.md exactly - use `using` statements for all SKPaint/SKPath objects to avoid memory leaks.
  </action>
  <verify>
Run `dotnet build src/PathPilot.Desktop/PathPilot.Desktop.csproj` - should compile without errors.
Verify file exists at src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs with ICustomDrawOperation implementation.
  </verify>
  <done>
SkillTreeCanvas.cs exists with:
- TreeData and AllocatedNodeIds styled properties
- ICustomDrawOperation inner class
- DrawConnections using SKPath batching
- DrawNodes with different sizes and colors for allocated/unallocated
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/PathPilot.Desktop/PathPilot.Desktop.csproj` compiles successfully
2. File src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs exists
3. Grep confirms ICustomDrawOperation implementation: `grep -l "ICustomDrawOperation" src/PathPilot.Desktop/Controls/`
4. Grep confirms SKCanvas usage: `grep "SKCanvas\|SkCanvas" src/PathPilot.Desktop/Controls/SkillTreeCanvas.cs`
</verification>

<success_criteria>
- SkillTreeCanvas control compiles and has ICustomDrawOperation for SkiaSharp rendering
- Control has TreeData and AllocatedNodeIds properties
- DrawConnections batches all lines into single SKPath
- DrawNodes renders circles with size based on node type and color based on allocation
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-rendering/02-01-SUMMARY.md`
</output>
